<template>

  <Layout>
    <div class="container-xxl mt-4">
      <h2 class="text-white text-center">📚 Gestion des Cours</h2>

      <!-- ✅ Sélecteur de prénom -->
      <div class="mb-3 text-center">
  <label for="studentSelect" class="text-white">Sélectionner un élève :</label>
<select v-model="selectedStudent" class="form-select mt-2" id="studentSelect">
  <option value="">Tous les élèves</option>
  <option v-for="student in uniqueStudents" :key="student" :value="student">
    {{ student }}
  </option>
</select>

</div>

<!-- ✅ Bouton de suppression -->
<div class="text-center mt-3" v-if="selectedStudent">
  <button @click="supprimerCours" class="btn btn-danger">❌ Supprimer les cours de {{ selectedStudent }}</button>
</div>


      <!-- ✅ Chargement -->
      <div v-if="loading" class="d-flex flex-column align-items-center mt-4">
        <div class="spinner-border text-primary mb-2" role="status"></div>
        <p class="text-muted">Chargement des cours...</p>
      </div>

      <!-- ✅ Message si aucun cours trouvé -->
      <div v-if="!loading && filteredCours.length === 0" class="alert alert-warning text-center mt-3">
        <p>Aucun cours trouvé.</p>
      </div>
<!-- ✅ Bouton pour activer/désactiver le filtre -->
<div class="mb-3 d-flex align-items-center gap-2">
  <input 
    type="checkbox" 
    id="filterUpcoming" 
    v-model="filterUpcoming"
    class="form-check-input"
  />
  <label for="filterUpcoming" class="form-check-label">
    Afficher uniquement les cours à venir 📅
  </label>
</div>

      <!-- ✅ Tableau des cours -->
      <div v-if="!loading && filteredCours.length > 0" class="table-responsive mt-3">
<div v-if="!loading && filteredCours.length > 0" class="table-responsive mt-3">
  <table class="table table-hover shadow-sm">
    <thead class="table-dark">
      <tr>
        <th scope="col">📆 Date & Heure</th>
        <th scope="col">🎸 Élève</th>
        <th scope="col">🔗 Lien Meet</th>
        <th scope="col">📝 Commentaires</th>
        <th scope="col">📄 Synthèse</th>
        <th scope="col">👀 Présence</th>
      </tr>
    </thead>
    <tbody>
      <tr 
        v-for="(cours, index) in filteredCours" 
        :key="index"
        @click="openEditModal(cours)" 
        class="clickable-row"
      >
        <!-- ✅ Format compact de la date -->
        <td><strong>{{ formatCompactDate(cours['Date et heure']) }}</strong></td>

        <!-- ✅ Prénom de l'élève -->
        <td>{{ cours.Prénom }}</td>

        <!-- ✅ Lien Google Meet avec icône cliquable -->
        <td>
          <a :href="cours['Lien Google Meet']" target="_blank" class="btn btn-primary btn-sm">
            📎 Ouvrir
          </a>
        </td>

        <!-- ✅ Commentaires -->
        <td>{{ cours.Commentaires || "Aucun commentaire" }}</td>

        <!-- ✅ Synthèse -->
        <td>{{ cours.Synthèse || "Non renseignée" }}</td>

        <!-- ✅ Case à cocher pour la présence -->
        <td>
          <input 
            type="checkbox" 
            v-model="cours.Présence" 
            @change="updatePresence(cours)"
            :true-value="'Présent'" 
            :false-value="'Absent'"
          />
        </td>
      </tr>
    </tbody>
  </table>
</div>



      </div>
    </div>
  </Layout>
  <!-- ✅ MODAL DE MODIFICATION -->
<div v-if="editModalOpen" class="modal show d-block" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Modifier le cours de {{ editedCours.Prénom }}</h5>
        <button type="button" class="btn-close" @click="closeEditModal"></button>
      </div>
      <div class="modal-body">
      <label class="form-label">Date et heure :</label>
<input type="datetime-local" v-model="editedCours['Date et heure']" class="form-control" />


        <label class="form-label mt-2">Lien Google Meet :</label>
        <input type="url" v-model="editedCours['Lien Google Meet']" class="form-control" />

        <label class="form-label mt-2">Lien Replay :</label>
        <input type="url" v-model="editedCours['Lien Replay']" class="form-control" />

        <label class="form-label mt-2">Trimestre :</label>
        <select v-model="editedCours.Trimestre" class="form-select">
          <option value="trimestre 1">Trimestre 1</option>
          <option value="trimestre 2">Trimestre 2</option>
          <option value="trimestre 3">Trimestre 3</option>
        </select>
        <!-- ✅ Présence : Case à cocher -->
<label class="form-label mt-2">Présence :</label>
<div class="form-check">
  <input 
    type="checkbox" 
    v-model="editedCours.Présence" 
    class="form-check-input" 
    id="presenceCheckbox"
    :true-value="'Présent'"
    :false-value="'Absent'"
  />
<!-- ✅ Champ pour modifier les commentaires -->
<label class="form-label mt-2">📝 Commentaires :</label>
<textarea 
  v-model="editedCours.Commentaires" 
  class="form-control" 
  rows="3" 
  placeholder="Ajouter un commentaire..."
></textarea>

<!-- ✅ Champ pour modifier la synthèse -->
<label class="form-label mt-2">📄 Synthèse :</label>
<textarea 
  v-model="editedCours.Synthèse" 
  class="form-control" 
  rows="3" 
  placeholder="Ajouter une synthèse..."
></textarea>

</div>

      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" @click="closeEditModal">Annuler</button>
        <button class="btn btn-success" @click="updateCours">✅ Enregistrer</button>
      </div>
      
    </div>
  </div>
</div>

</template>

<script>
import Layout from "../views/Layout.vue";
import axios from "axios";
import { ref, computed, onMounted } from "vue";
import { useRouter } from "vue-router";

export default {
  name: "Cours",
  components: { Layout },
  setup() {
    const filterUpcoming = ref(false);
    const router = useRouter();
    const coursData = ref([]);
    const loading = ref(true);
    const deleting = ref(false);
    const updating = ref(false);
    const selectedStudent = ref("");
    const editModalOpen = ref(false);
    const editedCours = ref({});
const successMessage = ref("");

const showSuccessMessage = (message) => {
  successMessage.value = message;
  setTimeout(() => {
    successMessage.value = "";
  }, 4000);
};
    const API_URL =
      "https://cors-proxy-37yu.onrender.com/https://script.google.com/macros/s/AKfycbyxduceUd1Gs0nVTD--NzcpO_is2Yx79YnPO3UU6Qba01QKSYSJkgjCi83AR-QU0QQZSA/exec";

    // ✅ Vérifie si l'utilisateur est connecté
    const isLoggedIn = computed(() => !!localStorage.getItem("jwt"));

    if (!isLoggedIn.value) {
      router.push("/login");
    }

    // ✅ Récupérer les cours depuis Google Sheets
   const fetchCours = async (noCache = false) => {
  loading.value = true;
  try {
    // ✅ Ajoute un timestamp UNIQUEMENT si `noCache` est vrai
    const url = `${API_URL}?route=suiviCours${noCache ? `&t=${Date.now()}` : ""}`;

    const response = await axios.get(url);

    if (response.data.status === "success") {
      coursData.value = response.data.data;
    } else {
      console.error("❌ Erreur API:", response.data.message);
    }
  } catch (error) {
    console.error("❌ Erreur lors du chargement des cours:", error);
  } finally {
    loading.value = false;
  }
};

    // ✅ Liste unique des prénoms
    const uniqueStudents = computed(() => {
      if (!coursData.value || coursData.value.length === 0) return [];
      
      const students = new Set(
        coursData.value
          .map((cours) => cours.Prénom?.trim())
          .filter(Boolean) // Supprime les valeurs vides
      );

      return Array.from(students).sort();
    });

    // ✅ Filtrage des cours
    const filteredCours = computed(() => {
      let filtered = [...coursData.value];

      if (selectedStudent.value) {
        filtered = filtered.filter(
          (cours) => cours.Prénom?.trim() === selectedStudent.value.trim()
        );
      }

      if (filterUpcoming.value) {
        const now = new Date();
        filtered = filtered.filter((cours) => {
          const courseDate = new Date(cours["Date et heure"]);
          return courseDate > now;
        });
      }

      return filtered;
    });
// ✅ Supprimer les cours d'un élève
const supprimerCours = async () => {
  if (!selectedStudent.value) {
    alert("❌ Sélectionnez un élève !");
    return;
  }

  const confirmation = confirm(`Voulez-vous vraiment supprimer tous les cours de ${selectedStudent.value} ?`);
  if (!confirmation) return;

  deleting.value = true;
  try {
    const requestBody = JSON.stringify({ route: "supprimerCoursEleve", prenom: selectedStudent.value });

    console.log("📡 Envoi de la requête avec le corps :", requestBody);

    const response = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: requestBody
    });

    const textResponse = await response.text();
    console.log("📥 Réponse brute :", textResponse);

    const result = JSON.parse(textResponse);
  if (result.status === "success") {
  showSuccessMessage(`✅ Les cours de ${selectedStudent.value} ont été supprimés avec succès !`);
  await fetchCours(true);
}
else {
      alert(`❌ Erreur : ${result.message}`);
    }
  } catch (error) {
    console.error("❌ Erreur de suppression :", error);
    alert("❌ Une erreur est survenue.");
  } finally {
    deleting.value = false;
  }
};


    // ✅ Ouvre la modale et charge les données du cours sélectionné
    const openEditModal = (cours) => {
      editedCours.value = { ...cours };
      editedCours.value.AncienneDate = cours["Date et heure"];

      if (editedCours.value["Date et heure"]) {
        const dateObj = new Date(editedCours.value["Date et heure"]);
        if (!isNaN(dateObj.getTime())) {
          const year = dateObj.getFullYear();
          const month = String(dateObj.getMonth() + 1).padStart(2, "0");
          const day = String(dateObj.getDate()).padStart(2, "0");
          const hours = String(dateObj.getHours()).padStart(2, "0");
          const minutes = String(dateObj.getMinutes()).padStart(2, "0");

          editedCours.value["Date et heure"] = `${year}-${month}-${day}T${hours}:${minutes}`;
        } else {
          console.error("❌ Date invalide :", editedCours.value["Date et heure"]);
        }
      }

      editModalOpen.value = true;
    };

    // ✅ Ferme la modale
    const closeEditModal = () => {
      editModalOpen.value = false;
      editedCours.value = {};
    };

    // ✅ Met à jour un cours
    const updateCours = async () => {
      if (!editedCours.value.Prénom || !editedCours.value["Date et heure"]) {
        alert("❌ Tous les champs doivent être remplis !");
        return;
      }

      updating.value = true;
      try {
        const response = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            route: "updateCours",
            cours: {
              ...editedCours.value,
              AncienneDate: editedCours.value.AncienneDate,
            },
          }),
        });

        const result = await response.json();

        if (result.status === "success") {
          alert("✅ Cours mis à jour !");
          await fetchCours(true);
          closeEditModal();
        } else {
          alert("❌ Erreur : " + result.message);
        }
      } catch (error) {
        console.error("❌ Erreur de mise à jour :", error);
        alert("❌ Une erreur est survenue.");
      } finally {
        updating.value = false;
      }
    };

    // ✅ Mise à jour de la présence
    const updatePresence = async (cours) => {
      editedCours.value = { ...cours };
      editedCours.value.Présence = cours.Présence ? "Présent" : "Absent";
      await updateCours();
    };

    // ✅ Format compact de la date
    const formatCompactDate = (isoDate) => {
      if (!isoDate) return "Date invalide";
      const dateObj = new Date(isoDate);

      if (isNaN(dateObj.getTime())) return "Date invalide";

      return `${dateObj.getDate().toString().padStart(2, "0")}/${(dateObj.getMonth() + 1)
        .toString()
        .padStart(2, "0")}/${dateObj.getFullYear()} à ${dateObj.getHours()
        .toString()
        .padStart(2, "0")}H${dateObj.getMinutes().toString().padStart(2, "0")}`;
    };

    onMounted(fetchCours);

    return {
      coursData, loading, deleting, updating, selectedStudent, filterUpcoming, filteredCours,
      supprimerCours, openEditModal, closeEditModal, updateCours, editModalOpen,
      editedCours, formatCompactDate, updatePresence, uniqueStudents,
    };
  },
};


</script>


<style scoped>
/* ✅ Ajuste la largeur et hauteur de la modale pour qu'elle soit bien centrée */
.modal-dialog {
  max-width: 50vw; /* Réduit la largeur pour éviter un effet trop grand sur desktop */
  width: auto;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh; /* Centre verticalement */
}

/* ✅ Contrôle la hauteur pour éviter d'être rogné */
.modal-content {
  width: 100%;
  max-height: 80vh; /* Empêche la modale de dépasser l'écran */
  overflow-y: auto; /* Active le scroll si nécessaire */
  border-radius: 10px; /* Ajoute un léger arrondi */
}

/* ✅ Meilleur affichage sur mobile */
@media (max-width: 768px) {
  .modal-dialog {
    max-width: 90vw; /* Largeur plus grande pour mobiles */
    margin: 10px;
  }

  .modal-content {
    max-height: 85vh; /* Ajuste la hauteur pour éviter le rognage */
  }
}

/* ✅ Fixe le problème de rognage en bas */
.modal-body {
  max-height: 60vh; /* Permet le défilement interne */
  overflow-y: auto;
  padding-bottom: 20px;
}

/* ✅ Fixe les boutons pour qu'ils restent visibles */
.modal-footer {
  position: sticky;
  bottom: 0;
  background: white;
  padding: 10px;
  display: flex;
  justify-content: space-between;
  border-top: 1px solid #ddd;
}


/* ✅ Style du filtre "Afficher uniquement les cours à venir" */
#filterUpcoming {
  accent-color: #ffcc00; /* ✅ Changer la couleur de la case à cocher */
}

label[for="filterUpcoming"] {
  color: #ffffff; /* ✅ Assurer une bonne lisibilité sur fond sombre */
  font-weight: bold;
}
/* ✅ Améliorer la visibilité du filtre */
.filter-container {
  background-color: rgba(255, 255, 255, 0.1); /* ✅ Légère transparence */
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ffffff50; /* ✅ Bordure discrète */
}

.loading-container {
  position: fixed;  /* Rend le loader toujours visible */
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);  /* Centre parfaitement */
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.8); /* Fond légèrement opaque pour la visibilité */
  z-index: 1000; /* Assure que le loader passe au-dessus */
}

.spinner-border {
  width: 2rem;
  height: 2rem;
  color: red !important;
}

h2 {
  font-weight: bold;
  color: #ffffff;
}

/* ✅ Amélioration du style du tableau */
.table-responsive {
  width: 100%;
  overflow-x: auto;
}

.table {
  border-radius: 10px;
  overflow: hidden;
  font-size: 1rem;
}

.table th, .table td {
  padding: 12px;
  text-align: center;
  vertical-align: middle;
  white-space: nowrap;
}

.table th {
  background-color: #212529;
  color: #ffffff;
}

.table-hover tbody tr:hover {
  background-color: rgba(0, 0, 0, 0.05);
  cursor: pointer;
}

/* ✅ Ajustements pour mobile */
@media (max-width: 768px) {
  .table th, .table td {
    padding: 8px;
    font-size: 0.9rem;
  }
}

@media (max-width: 576px) {
  .container-xxl {
    padding-left: 5px;
    padding-right: 5px;
  }
}
</style>
